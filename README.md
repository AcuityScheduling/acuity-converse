# Init.ai sample logic server

This repo contains a pre-configured webhook server for use in an [Init.ai](https://init.ai) project. The server can be used to facilitate testing from within the Init.ai console and can also be deployed remotely to handle your production traffic.

> Note: When taking your server to production, make sure to customize it to your needs and ensure it is fully tested!

Before getting started, make sure you have:

* An Init.ai account and project (https://console.init.ai)
* Node v6.10 or later ([Download](https://nodejs.org/en/download/))
  * Take a look at [nvm](https://github.com/creationix/nvm)

# Quickstart

1. Install dependencies and start development task:

    ```bash
    npm i && npm run dev
    ```
    
    You should see this in your terminal:
    ![demo-server](https://cloud.githubusercontent.com/assets/1217116/25285614/82bc3948-2680-11e7-830e-3abd50fd2ab4.gif)

1. Provide your server's address to the [Init.ai console](https://console.init.ai)

> **Note:** The `dev` task is not supported on Windows. If you are using Windows, see the [exposing localhost](#exposing-localhost) for instructions.

# Scaffold

This application contains a basic server configuration for handling webhooks as well as a boilerplate implementation of the Init.ai [Nods.js SDK](https://www.npmjs.com/package/initai-node). Out of the box, this application can be deployed to [Heroku](#heroku), but is designed to facilitate local development and testing as well.

### Server

The [server](server.js) is written using [express.js](http://expressjs.com/) â€“ you may use any framework you like (or build your own, we respect that too!). Out of the box, it is configured to handle a `POST` request to the `/` root endpoint. 

### Logic

#### Running your logic

The handler for the webhook endpoint will invoke the `runLogic` function which can be found in the [`runLogic.js`](runLogic.js) file. This function returns a [`Promise`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise) which will provide the result generated by the Init.ai client.

If you are using existing logic that was previously hosted by Init.ai, you may keep what you have written. See [migrating your logic](#migrating-your-logic) for more.

#### Sending the result

As mentioned above, the Promise resolved by `runLogic` will contain the necessary data to send to the Init.ai API for processing. This has been abstracted out into the [`sendLogicResult`](sendLogicResult.js) module.

# Running the server locally

To start the server and watch tasks:

```bash
$ npm run dev
```

The `dev` task automatically provisions an [ngrok](https://ngrok.com/) URL to [expose `localhost`](#exposing-localhost) and uses [`nodemon`](https://nodemon.io) to restart the server as you save changes. The server itself will default to `http://localhost:3022`. 

## Environment variables

* **PORT** - Set this if you wish to use a port other than the default (`3022`)
* **LOCAL** - Set this to `false` to skip automatic configuration of an `ngrok` URL

## Exposing localhost

This application can be run on any service you would like and ships completely ready to [deploy to Heroku](#heroku). During development however, it is recommended you make your local machine accessible to external services. We suggest using a tool such as [ngrok](https://ngrok.com/) or [localtunnel](https://localtunnel.github.io/www/).

This app contains an [ngrok wrapper](https://www.npmjs.com/package/ngrok) as a dependency. If you do not have [ngrok](https://ngrok.com) installed you can run: `npm run ngrok` to generate a URL which you can provide to the [Init.ai console](https://console.init.ai) for testing your project.

If you are using Windows, it is recommended that you start the server/watch task using `npm run watch` and then setup [ngrok](https://ngrok.com/#download) manually.

# Configuring webhooks

Init.ai facilitates both "development" and "production" webhooks. The intention is that the "development" webhook may be used to help you iterate on and test your project from the Init.ai console without having to connect to an external messaging service.

See [docs](https://docs.init.ai/v2.0/docs/webhooks) for more.

# Migrating your logic

In early versions of the Init.ai platform, logic was hosted on [AWS Lambda](https://aws.amazon.com/lambda/) instances provisioned automatically for each project. As such, certain patterns were applied to our [node library](https://www.npmjs.com/package/initai-node) and the projects scaffolded by Init.ai. Namely, this included a file located at `behavior/scripts/index.js` which exported a `handle` function to which an instantiated `client` was provided as an arugment:

```js
exports.handle = function (client) {
  ...
}
```

This pattern still works, however, now you are in charge of provisioning the `client` instance yourself. To do this from your webhook handler you may replace the `Logic.run` code block with the following:

```js
const InitClient = require('initai-node')
const logicScript = require('./behavior/scripts')

const initNodeClient = InitClient.create(data, {
  succeed(result) {
    sendLogicResult(data.payload)(result)
  }
})

logicScript.handle(initNodeClient)
```

Additionally, you may want to delete the accompanying `runLogic.js` file in this case.

# Deployments

## Heroku

[![Deploy](https://www.herokucdn.com/deploy/button.svg)](https://heroku.com/deploy)

# Support

* Email support@init.ai
* File an issue on this repo (Please limit issues to those related to running this webhook server)
* Join our [Slack](http://with.init.ai) comunity

# Coming soon

> _PRs for these are welcome!_

* [now.sh](https://zeit.co/now) deployment guide
* [serverless](https://serverless.com/) deployment guide
